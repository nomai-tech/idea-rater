<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Idea Rater</title>
  <style>
    :root {
      --bg: #070813;
      --card: #0f1022;
      --muted: #8ea0c6;
      --text: #e8edff;
      --accent: #ffd166;
      --danger: #ff3366;
      --success: #00d27a;
      --shadow: 0 20px 50px rgba(0, 0, 0, 0.35);
      --glass: rgba(255, 255, 255, 0.05);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Bai Jamjuree", "Trebuchet MS", sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(255, 51, 102, 0.25), transparent 30%),
                  radial-gradient(circle at 80% 10%, rgba(0, 210, 122, 0.25), transparent 28%),
                  radial-gradient(circle at 50% 80%, rgba(255, 209, 102, 0.18), transparent 30%),
                  var(--bg);
      color: var(--text);
      padding: 16px 12px 32px;
      overflow-x: hidden;
    }

.shell {
  width: 100%;
  max-width: none;
  display: grid;
  grid-template-columns: 300px minmax(0, 1fr);
  gap: 18px;
  align-items: stretch;
}

.sidebar-stack {
  display: grid;
  grid-template-rows: 1fr auto;
  gap: 12px;
  position: sticky;
  top: 12px;
  height: calc(100vh - 24px);
  align-content: stretch;
}

.main {
  display: grid;
  gap: 18px;
  grid-template-rows: auto auto 1fr;
  min-height: calc(100vh - 32px);
}

.top-grid {
  display: grid;
  grid-template-columns: minmax(0, 2fr) minmax(220px, 0.6fr);
  grid-template-areas:
    "input side";
  gap: 10px;
  align-items: stretch;
}

.input-col {
  grid-area: input;
  min-width: 0;
}

.rating-col {
  grid-area: side;
  display: flex;
  justify-content: flex-end;
  align-items: stretch;
}

.settings-pane {
  display: none;
  grid-area: side;
  align-content: start;
  gap: 12px;
  visibility: hidden;
}

.settings-head {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 10px;
}

.settings-head h3 {
  margin: 0;
  letter-spacing: 0.4px;
  text-transform: uppercase;
  color: var(--muted);
  font-size: 14px;
}

.settings-form {
  display: grid;
  gap: 10px;
}

.settings-form input {
  width: 100%;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  background: rgba(255, 255, 255, 0.04);
  color: var(--text);
  font-size: 14px;
  outline: none;
  transition: border 0.2s ease, box-shadow 0.2s ease;
}

.settings-form input:focus {
  border-color: rgba(0, 210, 122, 0.8);
  box-shadow: 0 0 0 4px rgba(0, 210, 122, 0.18);
}

.settings-form .help {
  color: var(--muted);
  font-size: 12px;
  margin: 0;
}

.hero {
  background: linear-gradient(120deg, rgba(255, 255, 255, 0.06), rgba(255, 255, 255, 0.02));
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 16px;
  padding: 16px;
  box-shadow: var(--shadow);
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  align-items: center;
  justify-content: space-between;
}

.hero-main {
  display: grid;
  gap: 6px;
}

h1 {
  margin: 0;
  letter-spacing: 0.6px;
  font-weight: 800;
  font-size: clamp(26px, 5vw, 36px);
}

p.lead {
  margin: 6px 0 0;
  color: var(--muted);
  max-width: 720px;
  line-height: 1.5;
}

.hero .lead {
  margin: 0;
}

.hero-meta {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
  align-items: center;
}

.chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 7px 10px;
  border-radius: 12px;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.06);
  font-weight: 700;
  letter-spacing: 0.3px;
  color: var(--text);
  font-size: 12px;
}

.chip.glow {
  background: linear-gradient(135deg, rgba(255, 51, 102, 0.22), rgba(0, 210, 122, 0.22));
  border-color: rgba(255, 255, 255, 0.14);
  box-shadow: 0 10px 30px rgba(255, 51, 102, 0.25);
}

    form {
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.04), rgba(255, 255, 255, 0.02));
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 16px;
      padding: 18px;
      display: grid;
      gap: 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }

    textarea {
      width: 100%;
      min-height: 140px;
      resize: vertical;
      padding: 12px 14px;
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      background: rgba(255, 255, 255, 0.04);
      color: var(--text);
      font-size: 15px;
      line-height: 1.5;
      outline: none;
      transition: border 0.2s ease, box-shadow 0.2s ease;
    }

    textarea:focus {
      border-color: rgba(255, 209, 102, 0.8);
      box-shadow: 0 0 0 4px rgba(255, 209, 102, 0.15);
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    button {
      cursor: pointer;
      border: none;
      padding: 12px 16px;
      border-radius: 10px;
      font-weight: 700;
      letter-spacing: 0.3px;
      transition: transform 0.1s ease, box-shadow 0.2s ease;
    }

    button.primary {
      background: linear-gradient(120deg, #ff3366, #ffd166, #00d27a);
      color: #0a0a0f;
      box-shadow: 0 10px 30px rgba(255, 51, 102, 0.35);
    }

    button.secondary {
      background: rgba(255, 255, 255, 0.08);
      color: var(--text);
      border: 1px solid rgba(255, 255, 255, 0.06);
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3);
    }

.results {
  display: grid;
  gap: 18px;
  grid-template-rows: 1fr;
  align-content: stretch;
  height: 100%;
  min-height: 50vh;
}

.arguments-grid {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 14px;
  grid-auto-rows: 1fr;
  height: 100%;
  align-items: stretch;
}

.rating-burst {
  position: relative;
  overflow: hidden;
  border-radius: 18px;
  padding: 22px;
  background: linear-gradient(135deg, #ff3366, #ffd166);
  box-shadow: 0 16px 36px rgba(255, 51, 102, 0.35);
  min-height: 220px;
  max-width: 380px;
  display: grid;
  place-items: center;
  text-align: center;
  isolation: isolate;
}

    .rating-burst::before,
    .rating-burst::after {
      content: "";
      position: absolute;
      inset: -40%;
      background: radial-gradient(circle at 30% 30%, rgba(255, 255, 255, 0.35), transparent 35%),
                  radial-gradient(circle at 70% 70%, rgba(0, 0, 0, 0.12), transparent 40%);
      filter: blur(8px);
      opacity: 0.8;
      z-index: 0;
      animation: swirl 14s linear infinite;
    }

    .rating-burst::after {
      animation-direction: reverse;
      opacity: 0.6;
    }

    @keyframes swirl {
      to {
        transform: rotate(360deg);
      }
    }

    .rating-value {
      font-size: clamp(52px, 10vw, 96px);
      font-weight: 800;
      letter-spacing: -1px;
      color: #0c0c14;
      z-index: 1;
      text-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
    }

    .rating-caption {
      margin-top: -10px;
      font-size: 15px;
      text-transform: uppercase;
      letter-spacing: 2px;
      color: rgba(12, 12, 20, 0.65);
      font-weight: 800;
      z-index: 1;
    }

.card {
  background: var(--card);
  border-radius: 16px;
  padding: 16px;
  border: 1px solid rgba(255, 255, 255, 0.06);
  box-shadow: var(--shadow);
  display: grid;
  grid-template-rows: auto 1fr;
  gap: 6px;
  height: 100%;
}

    .card h3 {
      margin: 0;
      font-size: 15px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      color: var(--muted);
      display: inline-flex;
      gap: 8px;
      align-items: center;
    }

    .card p {
      margin: 0;
      font-size: 15px;
      line-height: 1.5;
      color: var(--text);
    }

.argument-list {
  margin: 0;
  padding-left: 14px;
  display: block;
  color: var(--text);
  font-size: 15px;
  line-height: 1.45;
}

.argument-list.empty {
  list-style: none;
  padding-left: 0;
  color: var(--muted);
}

.argument-list li {
  margin: 2px 0;
}

    .status {
      color: var(--muted);
      font-size: 13px;
    }

    .pulse {
      animation: pulse 1.8s ease infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }

@media (max-width: 820px) {
  .shell { grid-template-columns: 1fr; }
  .top-grid { grid-template-columns: 1fr; grid-template-areas: "input" "side"; }
  .rating-col { justify-content: center; }
  .arguments-grid { grid-template-columns: 1fr; }
  .settings-pane { grid-column: 1; grid-row: auto; }
  .sidebar-stack { position: static; height: auto; }
  body { padding: 12px 10px 28px; }
}

    .sidebar {
      background: var(--card);
      border-radius: 16px;
      padding: 14px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 12px;
      height: 100%;
      min-height: 520px;
      max-height: 100%;
      overflow: hidden;
    }

    .sidebar-head {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .sidebar h2 {
      margin: 0;
      font-size: 16px;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      color: var(--muted);
    }

.idea-list {
  display: grid;
  gap: 8px;
  overflow: auto;
  padding-right: 4px;
  flex: 1;
  min-height: 200px;
  grid-auto-flow: row;
  align-content: start;
}

.idea-card {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.06);
  border-radius: 12px;
  padding: 8px 10px;
  display: grid;
  gap: 4px;
  cursor: pointer;
  transition: border 0.15s ease, transform 0.12s ease;
  height: 74px;
  align-content: center;
  overflow: hidden;
}

    .idea-card:hover {
      border-color: rgba(255, 209, 102, 0.6);
      transform: translateY(-1px);
    }

.idea-title {
  margin: 0;
  font-weight: 700;
  color: var(--text);
  font-size: 13px;
  line-height: 1.25;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.idea-meta {
  display: flex;
  align-items: center;
  gap: 6px;
  color: var(--muted);
  font-size: 11px;
    }

    .pill {
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      font-weight: 700;
      color: var(--text);
      font-size: 10px;
    }

    .lead.small {
      font-size: 13px;
    }

    .sidebar-footer {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sidebar button.full {
      width: 100%;
      justify-content: center;
      text-align: center;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

.settings-trigger {
  background: rgba(255, 255, 255, 0.06);
  color: var(--text);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 12px;
  padding: 12px 14px;
  font-weight: 700;
  letter-spacing: 0.3px;
  cursor: pointer;
  transition: border 0.15s ease, transform 0.12s ease, box-shadow 0.2s ease;
}

.settings-trigger:hover {
  border-color: rgba(255, 209, 102, 0.6);
  transform: translateY(-1px);
  box-shadow: 0 12px 32px rgba(0, 0, 0, 0.3);
}

body.show-settings .rating-col {
  display: none;
}

body.show-settings .settings-pane {
  display: grid;
  visibility: visible;
}

.banner {
  background: rgba(255, 51, 102, 0.12);
  border: 1px solid rgba(255, 51, 102, 0.4);
  color: var(--text);
  padding: 10px 12px;
  border-radius: 12px;
  display: none;
  font-weight: 700;
  letter-spacing: 0.2px;
  backdrop-filter: blur(6px);
  position: fixed;
  top: 10px;
  left: 12px;
  right: 12px;
  z-index: 50;
  box-sizing: border-box;
  max-width: calc(100% - 24px);
}

body.banner-visible {
  padding-top: 64px;
}
  </style>
</head>
<body>
  <div id="banner" class="banner"></div>
  <div class="shell">
    <div class="sidebar-stack">
      <aside class="sidebar">
        <div class="sidebar-head">
          <h2>Ideas</h2>
          <button id="clearHistory" class="secondary" type="button">Clear</button>
        </div>
        <p class="lead small">Each rating is saved locally so you can revisit it.</p>
        <div id="ideaList" class="idea-list"></div>
      </aside>
      <button id="settingsButton" class="settings-trigger" type="button">Settings</button>
    </div>

    <main class="main">
      <header class="hero">
        <div class="hero-main">
          <h1>Idea Rater</h1>
          <p class="lead">Paste a project idea, hit Rate, and get a loud score plus a quick pro and counter-argument to sanity-check the pitch.</p>
        </div>
        <div class="hero-meta">
          <span class="chip glow">Heuristic score</span>
          <span class="chip">Local history</span>
          <span class="chip">0–100 scale</span>
        </div>
      </header>

      <div class="top-grid">
        <div class="input-col">
          <form id="ideaForm">
            <label for="ideaInput" style="font-weight:700; letter-spacing:0.4px;">Your project idea</label>
            <textarea id="ideaInput" placeholder="Example: An AI co-pilot that helps small retailers manage inventory, forecast demand, and reorder with suppliers automatically."></textarea>
            <div class="actions">
              <button type="submit" class="primary">Rate this idea</button>
              <button type="button" id="surpriseBtn" class="secondary">Use a surprise idea</button>
              <span id="hint" style="color:var(--muted); font-size:13px;">Scores land between 0–100.</span>
            </div>
          </form>
        </div>
        <div class="rating-col">
          <div class="rating-burst pulse" id="ratingBurst">
            <div class="rating-value" id="ratingValue">--</div>
            <div class="rating-caption">idea rating</div>
          </div>
        </div>
        <div class="settings-pane card" id="settingsPane">
          <div class="settings-head">
            <h3>LLM Settings</h3>
            <button type="button" class="secondary" id="closeSettings">Close</button>
          </div>
          <p class="lead small">Save your LLM API key locally to use enhanced ratings. Key stays in your browser.</p>
          <form class="settings-form" id="settingsForm">
            <label for="apiKeyInput" style="font-weight:700; letter-spacing:0.3px;">API key</label>
            <input id="apiKeyInput" type="password" placeholder="sk-..." autocomplete="off" spellcheck="false">
            <p class="help">Stored in localStorage only; not sent to any server.</p>
            <button type="submit" class="primary">Save key</button>
          </form>
          <p class="status" id="settingsStatus">Waiting to save a key.</p>
        </div>
      </div>

      <section class="results">
        <div class="arguments-grid">
          <div class="card pro-card">
            <h3>Pro</h3>
            <ul id="proList" class="argument-list empty">
              <li>Waiting for an idea.</li>
            </ul>
          </div>
          <div class="card con-card">
            <h3>Counter</h3>
            <ul id="conList" class="argument-list empty">
              <li>Waiting for an idea.</li>
            </ul>
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    const ideaInput = document.getElementById("ideaInput");
    const ideaForm = document.getElementById("ideaForm");
    const ratingValue = document.getElementById("ratingValue");
    const ratingBurst = document.getElementById("ratingBurst");
    const proList = document.getElementById("proList");
    const conList = document.getElementById("conList");
    const surpriseBtn = document.getElementById("surpriseBtn");
    const ratingCol = document.querySelector(".rating-col");
    const ideaList = document.getElementById("ideaList");
    const clearHistoryBtn = document.getElementById("clearHistory");
    const settingsButton = document.getElementById("settingsButton");
    const settingsPane = document.getElementById("settingsPane");
    const settingsForm = document.getElementById("settingsForm");
    const apiKeyInput = document.getElementById("apiKeyInput");
    const settingsStatus = document.getElementById("settingsStatus");
    const closeSettingsBtn = document.getElementById("closeSettings");
    const banner = document.getElementById("banner");
    const SETTINGS_KEY = "ideaRaterLlmApiKey";

    const surpriseIdeas = [
      "A browser-based audio workstation that lets people co-compose music live with AI arranging stems on the fly.",
      "A neighborhood heat-pump marketplace that bundles permits, installers, financing, and maintenance with one flat rate.",
      "A developer tool that converts product briefs into instrumented feature flags with instant preview builds.",
      "A browser extension that rewrites legalese into plain English and tracks contract deltas as you negotiate.",
      "A micro-SaaS that scores SaaS trial accounts and triggers guided tours tailored to the user’s role and intent."
    ];

    const positiveSignals = [
      { keywords: ["ai", "machine learning", "ml", "model"], delta: 12, reason: "Leverages AI momentum for differentiation." },
      { keywords: ["climate", "carbon", "energy", "sustainability", "heat-pump"], delta: 10, reason: "Targets climate/energy tailwinds with supportive budgets." },
      { keywords: ["b2b", "enterprise", "compliance", "audit", "infrastructure"], delta: 8, reason: "Solves painful B2B workflows where budgets are real." },
      { keywords: ["marketplace", "platform", "network"], delta: 6, reason: "Platform angle could compound value once liquidity appears." },
      { keywords: ["automation", "workflow", "ops", "copilot"], delta: 7, reason: "Clear automation story with efficiency ROI." },
      { keywords: ["health", "wellness", "medical"], delta: 5, reason: "Health domain with meaningful impact and spend." },
      { keywords: ["education", "upskilling", "learning"], delta: 4, reason: "Upskilling space with durable demand." }
    ];

    const riskSignals = [
      { keywords: ["social network", "social app", "messaging", "chat app"], delta: -10, reason: "Crowded social space with brutal retention dynamics." },
      { keywords: ["crypto", "web3", "nft"], delta: -8, reason: "Volatile market perception and regulatory noise." },
      { keywords: ["ride sharing", "delivery", "logistics"], delta: -6, reason: "Operationally heavy with thin margins and fierce incumbents." },
      { keywords: ["vr", "ar", "metaverse"], delta: -5, reason: "Hardware adoption risk and unclear mainstream pull." },
      { keywords: ["dating"], delta: -4, reason: "High churn and expensive acquisition in dating." }
    ];

    const defaultPros = [
      "Problem framing suggests a real pain point that people might pay to solve.",
      "Market seems large enough to support multiple winners.",
      "Clear path to show ROI for early customers.",
      "Founders can ship a lean MVP quickly.",
      "Potential to layer network effects or data advantage."
    ];

    const defaultCons = [
      "Success hinges on sharp execution and a credible path to distribution.",
      "Acquiring early adopters may be expensive.",
      "Incumbents could fast-follow once traction appears.",
      "Regulatory or compliance risks could slow rollouts.",
      "Unit economics may be tight without strong pricing power."
    ];

    let ideaHistory = [];

    function clamp(value, min, max) {
      return Math.min(Math.max(value, min), max);
    }

    async function fetchLlmRating(idea, apiKey) {
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 12000);
      const body = {
        model: "gpt-4o-mini",
        messages: [
          { role: "system", content: "You are a concise startup rater. Respond with tight JSON only." },
          { role: "user", content: `Rate this idea on a 0-100 scale and give five pros and five cons. Respond only as JSON with keys score (0-100), pros (array of 5 short strings), cons (array of 5 short strings).\nIdea: ${idea}` }
        ],
        response_format: { type: "json_object" }
      };

      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${apiKey}`
        },
        body: JSON.stringify(body),
        signal: controller.signal
      });
      clearTimeout(timeout);

      if (!response.ok) {
        const err = new Error(`OpenAI request failed (${response.status})`);
        err.status = response.status;
        throw err;
      }

      const data = await response.json();
      const content = data?.choices?.[0]?.message?.content || "";
      let parsed;
      try {
        parsed = JSON.parse(content);
      } catch {
        throw new Error("OpenAI response was not valid JSON.");
      }
      const score = clamp(Number(parsed.score) || 0, 0, 100);
      const pros = Array.isArray(parsed.pros) ? parsed.pros : parsed.pro ? [parsed.pro] : [];
      const cons = Array.isArray(parsed.cons) ? parsed.cons : parsed.con ? [parsed.con] : [];
      return { score, pros, cons };
    }

    function matchSignals(text, signals) {
      const lower = text.toLowerCase();
      const hits = signals
        .filter(signal => signal.keywords.some(k => lower.includes(k)))
        .sort((a, b) => Math.abs(b.delta) - Math.abs(a.delta));
      return hits;
    }

    function scoreIdea(idea) {
      const cleanIdea = idea.trim();
      const base = 42;
      const lengthScore = clamp(cleanIdea.length / 4, 0, 22);
      const clarityScore = cleanIdea.includes(".") || cleanIdea.includes("\n") ? 6 : 0;
      let score = base + lengthScore + clarityScore;

      const pros = matchSignals(cleanIdea, positiveSignals);
      const cons = matchSignals(cleanIdea, riskSignals);

      pros.forEach(hit => score += hit.delta);
      cons.forEach(hit => score += hit.delta);

      // Mild randomness to avoid ties but keep deterministic for similar text.
      const randomness = Math.sin(cleanIdea.length) * 3;
      score += randomness;

      return clamp(Math.round(score), 0, 100);
    }

    function pickReason(hits, fallback) {
      if (hits.length) return hits[0].reason;
      return fallback;
    }

    function renderList(target, items, emptyText) {
      if (!target) return;
      const list = (items || []).filter(Boolean);
      if (!list.length) {
        target.innerHTML = `<li>${emptyText}</li>`;
        target.classList.add("empty");
        return;
      }
      target.classList.remove("empty");
      target.innerHTML = list
        .slice(0, 5)
        .map(item => `<li>${item}</li>`)
        .join("");
    }

    function ensureFive(items, fallbackPool) {
      const list = (items || []).filter(Boolean);
      if (list.length >= 5) return list.slice(0, 5);
      const extras = fallbackPool || [];
      return [...list, ...extras].slice(0, 5);
    }

    function buildArguments(idea) {
      const pros = matchSignals(idea, positiveSignals);
      const cons = matchSignals(idea, riskSignals);
      const proReasons = [...pros.map(p => p.reason), ...defaultPros];
      const conReasons = [...cons.map(c => c.reason), ...defaultCons];

      return {
        pros: proReasons.slice(0, 5),
        cons: conReasons.slice(0, 5)
      };
    }

    function shortTitle(text) {
      return text.length > 80 ? text.slice(0, 77) + "..." : text;
    }

    function loadHistory() {
      try {
        const raw = localStorage.getItem("ideaRaterHistory");
        ideaHistory = raw ? JSON.parse(raw) : [];
      } catch (err) {
        ideaHistory = [];
      }
      renderHistory();
    }

    function loadApiKey() {
      try {
        return localStorage.getItem(SETTINGS_KEY) || "";
      } catch (err) {
        return "";
      }
    }

    function persistApiKey(key) {
      try {
        localStorage.setItem(SETTINGS_KEY, key);
        settingsStatus.textContent = "Saved locally.";
      } catch (err) {
        settingsStatus.textContent = "Could not save. Check storage permissions.";
      }
    }

    function clearApiKey() {
      try {
        localStorage.removeItem(SETTINGS_KEY);
        settingsStatus.textContent = "Key cleared.";
      } catch (err) {
        settingsStatus.textContent = "Could not clear the key.";
      }
    }

    function showBanner(message) {
      if (!banner) return;
      banner.textContent = message;
      banner.style.display = "block";
      document.body.classList.add("banner-visible");
    }

    function hideBanner() {
      if (!banner) return;
      banner.style.display = "none";
      banner.textContent = "";
      document.body.classList.remove("banner-visible");
    }

    function toggleSettings(force) {
      const shouldOpen = force ?? !document.body.classList.contains("show-settings");
      document.body.classList.toggle("show-settings", shouldOpen);
      settingsPane.hidden = !shouldOpen;
      ratingCol.hidden = shouldOpen;
      if (shouldOpen) {
        apiKeyInput.value = loadApiKey();
        settingsStatus.textContent = apiKeyInput.value ? "Key loaded from local storage." : "Waiting to save a key.";
        setTimeout(() => apiKeyInput.focus(), 60);
      } else {
        settingsStatus.textContent = apiKeyInput.value ? "Key loaded from local storage." : "Waiting to save a key.";
      }
    }

    function persistHistory() {
      try {
        localStorage.setItem("ideaRaterHistory", JSON.stringify(ideaHistory));
      } catch (err) {
        console.warn("Could not persist history", err);
      }
    }

    function addHistoryEntry(entry) {
      const enriched = { id: Date.now().toString(36) + Math.random().toString(36).slice(2, 6), createdAt: Date.now(), ...entry };
      ideaHistory = [enriched, ...ideaHistory].slice(0, 50);
      persistHistory();
      renderHistory();
    }

    function renderHistory() {
      if (!ideaHistory.length) {
        ideaList.innerHTML = `<p class="status">No ideas yet.</p>`;
        return;
      }
      ideaList.innerHTML = ideaHistory
        .map(item => {
          const source = item.source === "heuristic" ? "Heuristic" : item.source || "Heuristic";
          return `
            <div class="idea-card" data-id="${item.id}">
              <div class="idea-meta">
                <span class="pill">Score ${item.score}</span>
                <span class="pill">${source}</span>
              </div>
              <p class="idea-title">${shortTitle(item.idea || "Untitled idea")}</p>
            </div>
          `;
        })
        .join("");
    }

    function ratingToGradient(score) {
      // Map score 0-100 to hue range 0-140 (red to green).
      const hue = (score / 100) * 140;
      const accentHue = (hue + 60) % 360;
      const start = `hsl(${hue}, 95%, 55%)`;
      const end = `hsl(${accentHue}, 95%, 50%)`;
      const shadow = `0 18px 48px rgba(0, 0, 0, 0.38), 0 12px 32px hsla(${hue}, 90%, 45%, 0.35)`;
      return { start, end, shadow };
    }

    function render(score, pros, cons) {
      ratingValue.textContent = score;
      const gradient = ratingToGradient(score);
      ratingBurst.style.background = `linear-gradient(135deg, ${gradient.start}, ${gradient.end})`;
      ratingBurst.style.boxShadow = gradient.shadow;
      renderList(proList, pros, "Waiting for an idea.");
      renderList(conList, cons, "Waiting for an idea.");
      syncRatingSize();
    }

    function syncRatingSize() {
      const available = ratingCol?.clientWidth || 0;
      const formHeight = ideaForm?.offsetHeight || 0;
      const candidates = [available, formHeight].filter(Boolean);
      const baseSize = candidates.length ? Math.min(...candidates) : 0;
      const size = Math.max(220, baseSize);
      if (size > 0) {
        ratingBurst.style.width = `${size}px`;
        ratingBurst.style.height = `${size}px`;
      }
    }

    async function handleSubmit(event) {
      event.preventDefault();
      const idea = ideaInput.value.trim();
      if (!idea) {
        render("--", ["Drop in an idea to get a score."], ["No counter-argument without an idea."]);
        return;
      }
      hideBanner();
      ratingBurst.classList.add("pulse");
      ratingValue.textContent = "···";
      renderList(proList, ["Thinking...", "Thinking...", "Thinking...", "Thinking...", "Thinking..."], "Thinking...");
      renderList(conList, ["Thinking...", "Thinking...", "Thinking...", "Thinking...", "Thinking..."], "Thinking...");
      const apiKey = loadApiKey();
      if (!apiKey) {
        showBanner("Add an OpenAI API key in Settings to generate ratings.");
        ratingValue.textContent = "--";
        renderList(proList, ["API key required to show pros."], "API key required.");
        renderList(conList, ["API key required to show cons."], "API key required.");
        ratingBurst.classList.remove("pulse");
        return;
      }
      let source = "heuristic";
      try {
        renderList(proList, ["Calling OpenAI..."], "Calling OpenAI...");
        renderList(conList, ["Awaiting LLM..."], "Awaiting LLM...");
        const llmResult = await fetchLlmRating(idea, apiKey);
        const pros = ensureFive(llmResult.pros, defaultPros);
        const cons = ensureFive(llmResult.cons, defaultCons);
        render(llmResult.score, pros, cons);
        addHistoryEntry({ idea, score: llmResult.score, pros, cons, source: "OpenAI" });
        source = "OpenAI";
      } catch (err) {
        if (err?.status === 401) {
          showBanner("OpenAI API key looks invalid (401). Please re-enter it in Settings.");
        }
        console.warn("OpenAI rating failed, falling back.", err);
      }

      if (source !== "OpenAI") {
        const score = scoreIdea(idea);
        const { pros, cons } = buildArguments(idea);
        render(score, pros, cons);
        addHistoryEntry({ idea, score, pros, cons, source: "Heuristic" });
      }

      ratingBurst.classList.remove("pulse");
      syncRatingSize();
    }

    function injectSurprise() {
      const idea = surpriseIdeas[Math.floor(Math.random() * surpriseIdeas.length)];
      ideaInput.value = idea;
      ideaInput.focus();
      handleSubmit(new Event("submit"));
    }

    function handleHistoryClick(event) {
      const card = event.target.closest(".idea-card");
      if (!card) return;
      const id = card.dataset.id;
      const entry = ideaHistory.find(item => item.id === id);
      if (!entry) return;
      ideaInput.value = entry.idea;
      const pros = entry.pros || (entry.pro ? [entry.pro] : []);
      const cons = entry.cons || (entry.con ? [entry.con] : []);
      render(entry.score, pros, cons);
    }

    function clearHistory() {
      ideaHistory = [];
      persistHistory();
      renderHistory();
    }

    ideaForm.addEventListener("submit", handleSubmit);
    surpriseBtn.addEventListener("click", injectSurprise);
    ideaList.addEventListener("click", handleHistoryClick);
    clearHistoryBtn.addEventListener("click", clearHistory);
    settingsButton.addEventListener("click", () => toggleSettings());
    closeSettingsBtn.addEventListener("click", () => toggleSettings(false));
    settingsForm.addEventListener("submit", (event) => {
      event.preventDefault();
      const key = apiKeyInput.value.trim();
      if (!key) {
        clearApiKey();
        toggleSettings(false);
        return;
      }
      persistApiKey(key);
      toggleSettings(false);
    });

    loadHistory();
    // Ensure settings panel is hidden on initial load
    toggleSettings(false);
    syncRatingSize();
    window.addEventListener("resize", syncRatingSize);
  </script>
</body>
</html>
